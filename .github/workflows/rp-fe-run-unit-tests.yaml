name: Reusable Research Platform UI Unit Test
on:
  workflow_call:
    inputs:
      projects:
        description: 'Comma-separated list of UI projects to test (e.g., "UI/cinesysplus,UI/copilot")'
        required: true
        type: string
      node-version:
        description: 'Node.js version'
        required: false
        default: '12.x'
        type: string
jobs:
  Unit-Tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Parse into array from string (comma separated)
        project: ${{ fromJson(inputs.projects) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      # This needs to be run on every matrix
      - name: Setup Shared UI
        working-directory: UI/shared-ui
        run: |
          sed -i 's#input: "dist/esm/dist/dts/index\.d\.ts",#input: "dist/esm/index.d.ts",#' rollup.config.js
          npm i -g yarn yalc
          npm i
          npm run build

      - name: Setup ${{ matrix.project }}
        working-directory: ${{ matrix.project }}
        run: |
          yalc add shared-ui
          npm i

      - name: Run Eslint for ${{ matrix.project }}
        id: eslint-tests
        working-directory: ${{ matrix.project }}
        continue-on-error: true
        run: |
          npm run test:clean || echo "test:clean failed, continuing..."
          npm run lint

      - name: Run Jest for ${{ matrix.project }}
        id: jest-tests
        working-directory: ${{ matrix.project }}
        continue-on-error: true
        run: |
          npx cross-env NODE_ENV=test jest --coverage

      - name: Comment failure on PR
        if: ${{ (steps.jest-tests.outcome == 'failure' || steps.eslint-tests.outcome == 'failure') && github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          hide_and_recreate: true
          hide_classify: "OUTDATED"
          header: test-results
          message: |
            ‚ùå **Unit tests failed!** for ${{ matrix.project }}
            - Commit: ${{ github.sha }}
            Please review the test logs in the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

      - name: Fail job if tests failed
        if: ${{ steps.jest-tests.outcome == 'failure' || steps.eslint-tests.outcome == 'failure' }}
        run: exit 1

  Summary:
    runs-on: ubuntu-latest
    needs: [Unit-Tests]
    if: always()
    steps:
      - name: Show overall status
        run: |
          if [[ "${{ needs.Unit-Tests.result }}" == "failure" ]]; then
            echo "One or more test suites failed."
            exit 1
          else
            echo "All tests passed or were skipped."
          fi

